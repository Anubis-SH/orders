<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | نظام متابعة الطلبات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            scroll-behavior: smooth;
            background-color: #f8fafc; /* slate-50 */
        }
        .btn-primary {
            @apply inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-base font-bold text-white shadow-lg shadow-indigo-500/30 transition-all hover:bg-indigo-700 hover:shadow-indigo-500/50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2;
        }
        .btn-secondary {
            @apply inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-base font-bold text-slate-800 shadow-sm transition-all hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300 focus:ring-offset-2;
        }
        .btn-danger {
            @apply inline-flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2.5 text-base font-bold text-white shadow-lg shadow-red-500/30 transition-all hover:bg-red-700 hover:shadow-red-500/50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
        }
        .tab-active {
            @apply border-indigo-600 text-indigo-600;
        }
        .tab-inactive {
            @apply border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300;
        }
        .timeline-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        /* Modal Animation */
        .modal-content-transition {
             transition: all 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3">
                    <div class="text-indigo-600">
                        <i data-feather="check-square" class="w-8 h-8"></i>
                    </div>
                    <h1 class="text-2xl font-extrabold text-slate-800">لوحة التحكم</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-base text-slate-600 font-semibold hidden sm:block"></span>
                    <button id="logout-btn" title="تسجيل الخروج" class="btn-secondary !px-3 !py-2">
                        <i data-feather="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        <div class="px-4 sm:px-0">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-extrabold text-slate-900">متابعة الطلبات</h2>
                <button id="add-order-btn" class="btn-primary hidden w-full sm:w-auto">
                    <i data-feather="plus-circle" class="w-6 h-6"></i>
                    <span>إضافة طلب جديد</span>
                </button>
            </div>

            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex gap-6" aria-label="Tabs">
                    <button id="active-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-bold text-lg tab-active">الطلبات الحالية</button>
                    <button id="archive-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-bold text-lg tab-inactive">سجل الطلبات</button>
                </nav>
            </div>
            
            <div id="active-orders-content">
                 <div class="relative mb-6">
                    <input type="text" id="search-active-input" placeholder="ابحث بكود الطلب, اسم العميل أو المنتج..." class="w-full pl-12 pr-4 py-3 text-lg border-2 border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-feather="search" class="w-6 h-6 text-slate-400"></i>
                    </div>
                </div>
                <div id="orders-list" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
                <div id="no-orders-message" class="hidden text-center py-16 bg-white rounded-xl shadow-md">
                    <i data-feather="folder" class="w-16 h-16 mx-auto text-slate-400"></i>
                    <p class="mt-4 text-xl font-bold text-slate-700">لا توجد طلبات حالية لعرضها.</p>
                </div>
            </div>

            <div id="archived-orders-content" class="hidden">
                <div class="relative mb-6">
                    <input type="text" id="search-archive-input" placeholder="ابحث بكود الطلب, اسم العميل أو المنتج..." class="w-full pl-12 pr-4 py-3 text-lg border-2 border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-feather="search" class="w-6 h-6 text-slate-400"></i>
                    </div>
                </div>
                <div id="archived-orders-list" class="space-y-3"></div>
                <div id="no-archived-orders-message" class="hidden text-center py-16 bg-white rounded-xl shadow-md">
                    <i data-feather="archive" class="w-16 h-16 mx-auto text-slate-400"></i>
                    <p class="mt-4 text-xl font-bold text-slate-700">سجل الطلبات فارغ.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-slate-900 bg-opacity-70 transition-opacity"> <div class="flex items-center justify-center min-h-screen p-4"> <div class="relative bg-white rounded-2xl shadow-2xl p-8 m-4 max-w-lg w-full transform modal-content-transition scale-95 opacity-0" id="modal-content"> <h3 class="text-2xl font-extrabold mb-6 text-center" id="modal-title">إضافة طلب جديد</h3> <form id="order-form" class="space-y-6"> <div><label class="block text-base font-bold text-slate-700 mb-2">كود الطلب</label><input type="text" value="يتم إنشاؤه تلقائياً" disabled class="mt-1 block w-full rounded-lg border-slate-300 bg-slate-100 text-slate-500 shadow-sm text-lg p-3 cursor-not-allowed"></div><div> <label for="customer-name" class="block text-base font-bold text-slate-700 mb-2">اسم العميل</label> <input type="text" id="customer-name" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-3"> </div> <div> <label for="product-name" class="block text-base font-bold text-slate-700 mb-2">اسم المنتج</label> <input type="text" id="product-name" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-3"> </div> <div> <label for="quantity" class="block text-base font-bold text-slate-700 mb-2">الكمية المطلوبة</label> <input type="number" id="quantity" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-3"> </div> <div> <label for="order-type" class="block text-base font-bold text-slate-700 mb-2">نوع الطلب</label> <select id="order-type" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-3"> <option value="" disabled selected>اختر نوع الطلب</option> <option value="flexo">فليكسو</option> <option value="offset">أوفست</option> </select> </div> <div id="flexo-options" class="hidden pt-2"> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="requires-form" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-base font-semibold text-slate-800">هذا الطلب يتطلب فورمة</span> </label> </div> <div class="pt-6 flex flex-col-reverse sm:flex-row justify-end gap-3"> <button type="button" id="cancel-btn" class="btn-secondary w-full sm:w-auto">إلغاء</button> <button type="submit" class="btn-primary w-full sm:w-auto">حفظ الطلب</button> </div> </form> </div> </div> </div>
    
    <div id="notes-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-slate-900 bg-opacity-70"> <div class="flex items-center justify-center min-h-screen p-4"> <div class="relative bg-white rounded-2xl shadow-2xl p-8 m-4 max-w-lg w-full transform modal-content-transition scale-95 opacity-0" id="notes-modal-content"> <h3 class="text-2xl font-extrabold mb-6 text-center" id="notes-modal-title">إضافة ملاحظات</h3> <form id="notes-form"> <input type="hidden" id="notes-order-id"> <input type="hidden" id="notes-stage-id"> <div> <label for="stage-notes" class="block text-base font-bold text-slate-700 mb-2">الملاحظات</label> <textarea id="stage-notes" rows="5" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-3"></textarea> </div> <div class="pt-6 flex flex-col-reverse sm:flex-row justify-end gap-3"> <button type="button" id="cancel-notes-btn" class="btn-secondary w-full sm:w-auto">إلغاء</button> <button type="submit" class="btn-primary w-full sm:w-auto">حفظ الملاحظات</button> </div> </form> </div> </div> </div>
    
    <div id="stop-order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-slate-900 bg-opacity-70"> <div class="flex items-center justify-center min-h-screen p-4"> <div class="relative bg-white rounded-2xl shadow-2xl p-8 m-4 max-w-lg w-full transform modal-content-transition scale-95 opacity-0" id="stop-order-modal-content"> <h3 class="text-2xl font-extrabold mb-6 text-center text-red-600">إيقاف الطلب</h3> <form id="stop-order-form"> <input type="hidden" id="stop-order-id"> <div> <label for="stop-reason" class="block text-base font-bold text-slate-700 mb-2">سبب الإيقاف (إجباري)</label> <textarea id="stop-reason" rows="5" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500 text-lg p-3"></textarea> </div> <div class="pt-6 flex flex-col-reverse sm:flex-row justify-end gap-3"> <button type="button" id="cancel-stop-btn" class="btn-secondary w-full sm:w-auto">إلغاء</button> <button type="submit" class="btn-danger w-full sm:w-auto">تأكيد الإيقاف</button> </div> </form> </div> </div> </div>

    <div id="archive-detail-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-slate-900 bg-opacity-70">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl p-8 m-4 max-w-2xl w-full transform modal-content-transition scale-95 opacity-0" id="archive-detail-modal-content">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                    <h3 class="text-2xl font-extrabold text-slate-900" id="archive-modal-title">تفاصيل الطلب</h3>
                    <button id="close-archive-modal-btn" class="text-slate-500 hover:text-slate-800">
                         <i data-feather="x" class="w-8 h-8"></i>
                    </button>
                </div>
                <div id="archive-modal-body" class="max-h-[70vh] overflow-y-auto pr-2 space-y-4">
                    </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, query, where, updateDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZ41NK4xWlrCjah1O9XP-1jp2bkR8nNuc", // Replace with your actual config
            authDomain: "arabia-orders.firebaseapp.com",
            projectId: "arabia-orders",
            storageBucket: "arabia-orders.appspot.com",
            messagingSenderId: "1098475426096",
            appId: "1:1098475426096:web:25bc7f0afc82d247c3b8f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STAGES DEFINITION ---
        const STAGES = {
            flexo: [ { id: 'supply_order', name: 'أمر توريد', dependencies: [] }, { id: 'design', name: 'التصميم والاعتماد', dependencies: [] }, { id: 'materials', name: 'توفير الخامات', dependencies: [] }, { id: 'form', name: 'توفير فورمة', dependencies: [], optional: true }, { id: 'production_line', name: 'خط الإنتاج', dependencies: ['materials'] }, { id: 'sareel', name: 'توفير السريل', dependencies: ['design'] }, { id: 'printing', name: 'الطباعة', dependencies: ['production_line', 'sareel'] }, { id: 'cutting', name: 'التكسير / التفتيح', dependencies: ['printing'] }, { id: 'gluing', name: 'اللصق / الدبوس', dependencies: ['cutting'] }, { id: 'packaging', name: 'شنبر / استرتش', dependencies: ['gluing'] }, { id: 'loading', name: 'التحميل والتسليم', dependencies: ['packaging'] }, ],
            offset: [ { id: 'supply_order', name: 'أمر توريد', dependencies: [] }, { id: 'form', name: 'توفير الفورمة', dependencies: [] }, { id: 'design', name: 'التصميم', dependencies: ['form'] }, { id: 'zinkat', name: 'توفير الزنكات', dependencies: ['design'] }, { id: 'materials', name: 'توفير الخامات', dependencies: [] }, { id: 'sheeter', name: 'الشيتر', dependencies: ['materials'] }, { id: 'printing', name: 'الطباعة', dependencies: ['sheeter', 'zinkat'] }, { id: 'coating', name: 'سلوفان / UV', dependencies: ['printing'] }, { id: 'merging', name: 'الدمج', dependencies: ['coating'] }, { id: 'cutting', name: 'التكسير', dependencies: ['merging'] }, { id: 'gluing', name: 'اللصق / الدبوس', dependencies: ['cutting'] }, { id: 'packaging', name: 'شنبر / استرتش', dependencies: ['gluing'] }, { id: 'loading', name: 'التحميل والتسليم', dependencies: ['packaging'] }, ]
        };

        // --- UI ELEMENTS ---
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const addOrderBtn = document.getElementById('add-order-btn');
        const ordersListEl = document.getElementById('orders-list');
        const noOrdersMessage = document.getElementById('no-orders-message');
        const archivedOrdersListEl = document.getElementById('archived-orders-list');
        const noArchivedOrdersMessage = document.getElementById('no-archived-orders-message');
        const activeTab = document.getElementById('active-tab');
        const archiveTab = document.getElementById('archive-tab');
        const activeContent = document.getElementById('active-orders-content');
        const archivedContent = document.getElementById('archived-orders-content');
        const searchActiveInput = document.getElementById('search-active-input');
        const searchArchiveInput = document.getElementById('search-archive-input');
        
        // Modals
        const orderModal = document.getElementById('order-modal'); const modalContent = document.getElementById('modal-content'); const orderForm = document.getElementById('order-form'); const cancelBtn = document.getElementById('cancel-btn'); const flexoOptions = document.getElementById('flexo-options'); const orderTypeSelect = document.getElementById('order-type'); const notesModal = document.getElementById('notes-modal'); const notesModalContent = document.getElementById('notes-modal-content'); const notesForm = document.getElementById('notes-form'); const cancelNotesBtn = document.getElementById('cancel-notes-btn'); const stopOrderModal = document.getElementById('stop-order-modal'); const stopOrderModalContent = document.getElementById('stop-order-modal-content'); const stopOrderForm = document.getElementById('stop-order-form'); const cancelStopBtn = document.getElementById('cancel-stop-btn');
        const archiveDetailModal = document.getElementById('archive-detail-modal'); const archiveDetailModalContent = document.getElementById('archive-detail-modal-content'); const closeArchiveModalBtn = document.getElementById('close-archive-modal-btn'); const archiveModalBody = document.getElementById('archive-modal-body'); const archiveModalTitle = document.getElementById('archive-modal-title');

        const mainContainer = document.querySelector('main');

        let currentUser = null;
        let userRole = null;
        let unsubscribeActive = null;
        let unsubscribeArchived = null;
        let allActiveOrders = [];
        let allArchivedOrders = [];

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userEmailEl.textContent = user.email;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    userRole = userDocSnap.data().role;
                    setupUIForRole(userRole);
                    listenForActiveOrders(userRole, user.uid);
                    listenForArchivedOrders(userRole, user.uid);
                } else { handleLogout(); }
            } else { window.location.href = 'login.html'; }
            feather.replace();
        });

        function setupUIForRole(role) {
            if (role === 'rep') addOrderBtn.classList.remove('hidden');
        }
        
        // --- DATA HANDLING ---
        function listenForActiveOrders(role, uid) {
            if (unsubscribeActive) unsubscribeActive();
            let q = query(collection(db, "orders"), where("status", "==", "active"));
            if (role === 'rep') q = query(q, where("createdBy", "==", uid));
            unsubscribeActive = onSnapshot(q, (snapshot) => {
                allActiveOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderActiveOrders(allActiveOrders);
                noOrdersMessage.classList.toggle('hidden', !snapshot.empty);
            });
        }

        function listenForArchivedOrders(role, uid) {
            if (unsubscribeArchived) unsubscribeArchived();
            let q = query(collection(db, "orders"), where("status", "in", ["completed", "stopped"]));
            if (role === 'rep') q = query(q, where("createdBy", "==", uid));
            unsubscribeArchived = onSnapshot(q, (snapshot) => {
                allArchivedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderArchivedOrders(allArchivedOrders);
                noArchivedOrdersMessage.classList.toggle('hidden', !snapshot.empty);
            });
        }

        // --- RENDERING ---
        function renderActiveOrders(orders) {
            ordersListEl.innerHTML = '';
            orders.forEach(order => {
                const completedStagesCount = (order.stages || []).filter(s => s.status === 'completed').length;
                const totalStages = (order.stages || []).length;
                const progress = totalStages > 0 ? (completedStagesCount / totalStages) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 flex flex-col';
                
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h3 class="font-extrabold text-2xl text-slate-900">${order.productName}</h3>
                            <span class="text-lg font-bold text-indigo-600">#${order.orderCode || 'N/A'}</span>
                        </div>
                        <p class="text-base text-slate-600 mt-2 font-semibold">للعميل: ${order.customerName}</p>
                        <div class="mt-6">
                            <div class="flex justify-between mb-2">
                                <span class="text-base font-bold text-slate-700">التقدم</span>
                                <span class="text-base font-bold text-indigo-700">${Math.round(progress)}%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-3">
                                <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                         <button class="expand-details-btn w-full text-indigo-600 font-bold flex items-center justify-center gap-2" data-order-id="${order.id}">
                            <span>عرض التفاصيل</span>
                            <i data-feather="chevron-down" class="transition-transform"></i>
                         </button>
                    </div>
                    <div id="timeline-${order.id}" class="timeline-details mt-4 pt-4 border-t border-slate-200 space-y-4"></div>
                `;
                ordersListEl.appendChild(card);
            });
            feather.replace();
        }

        function renderArchivedOrders(orders) {
            archivedOrdersListEl.innerHTML = '';
            orders.forEach(order => {
                let statusBadge = '';
                if (order.status === 'stopped') {
                    statusBadge = `<span class="text-sm font-bold px-3 py-1 rounded-full bg-red-100 text-red-800">متوقف</span>`;
                } else if (order.status === 'completed') {
                    statusBadge = `<span class="text-sm font-bold px-3 py-1 rounded-full bg-green-100 text-green-800">مكتمل</span>`;
                }

                const item = document.createElement('div');
                item.className = 'bg-white rounded-xl shadow-md p-4 flex justify-between items-center transition-all hover:shadow-lg hover:ring-2 hover:ring-indigo-500';
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-lg font-extrabold text-indigo-600">#${order.orderCode || 'N/A'}</span>
                        <div>
                            <h4 class="font-bold text-lg text-slate-800">${order.productName}</h4>
                            <p class="text-sm text-slate-500">${order.customerName}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        ${statusBadge}
                        <button data-order-id="${order.id}" class="view-archive-btn btn-secondary !px-3 !py-1.5 !text-sm">
                             <i data-feather="eye" class="w-4 h-4 mr-1"></i>
                             عرض
                        </button>
                    </div>
                `;
                archivedOrdersListEl.appendChild(item);
            });
            feather.replace();
        }

        function renderTimeline(container, order, orderId) {
            container.innerHTML = '';
            if (!order.stages) return; 

            const isStopped = order.status === 'stopped';
            const isCompleted = order.status === 'completed';
            
            if (isStopped) {
                container.innerHTML += `<div class="bg-red-50 border-r-4 border-red-500 p-4 rounded-lg mb-6"><div class="flex items-center"><i data-feather="alert-triangle" class="w-8 h-8 text-red-600 ml-4"></i><div><h4 class="font-extrabold text-lg text-red-800">هذا الطلب متوقف</h4><p class="text-red-700 mt-1">${order.stopReason}</p></div></div></div>`;
            }

            const completedStageIds = new Set(order.stages.filter(s => s.status === 'completed').map(s => s.id));

            order.stages.forEach((stage) => {
                const isStageCompleted = stage.status === 'completed';
                const areDependenciesMet = (stage.dependencies || []).every(depId => completedStageIds.has(depId));
                const canComplete = userRole === 'rep' && !isStageCompleted && areDependenciesMet && !isStopped && !isCompleted;
                const endDate = stage.endDate ? new Date(stage.endDate.seconds * 1000).toLocaleDateString('ar-EG') : '...';

                const item = document.createElement('div');
                item.className = 'relative flex items-start';

                item.innerHTML = `<div class="absolute top-5 right-5 -bottom-4 w-0.5 ${isStageCompleted ? 'bg-green-500' : 'bg-slate-300'}"></div><div class="absolute top-0 right-0 z-10 h-10 w-10 rounded-full flex items-center justify-center text-white flex-shrink-0 ${isStageCompleted ? 'bg-green-500' : (canComplete ? 'bg-indigo-500' : 'bg-slate-400')}"><i data-feather="${isStageCompleted ? 'check' : (canComplete ? 'play' : 'lock')}" class="w-6 h-6"></i></div><div class="mr-14 flex-1 min-w-0"><div class="flex justify-between items-center gap-2"><h4 class="font-bold text-lg text-slate-800 truncate">${stage.name}</h4><div class="flex-shrink-0 flex items-center gap-2">${canComplete ? `<button data-order-id="${orderId}" data-stage-id="${stage.id}" class="complete-stage-btn text-xs sm:text-sm bg-green-100 text-green-800 font-bold hover:bg-green-200 px-2 sm:px-3 py-1 rounded-md transition whitespace-nowrap">إكمال</button>` : ''}${userRole === 'rep' && !isStopped && !isCompleted ? `<button data-order-id="${orderId}" data-stage-id="${stage.id}" data-stage-name="${stage.name}" data-current-notes="${stage.notes || ''}" class="add-notes-btn text-slate-500 hover:text-indigo-600 p-1 rounded-full transition"><i data-feather="edit-3" class="w-5 h-5"></i></button>` : ''}</div></div><p class="text-sm text-slate-500 mt-1">${isStageCompleted ? `اكتملت في: ${endDate}` : (areDependenciesMet ? 'جاهزة للبدء' : 'في الانتظار')}</p>${stage.notes ? `<div class="text-sm bg-yellow-50 border border-yellow-200 p-3 rounded-lg mt-2 text-yellow-800">${stage.notes}</div>` : ''}</div>`;
                container.appendChild(item);
            });
            
            if (userRole === 'rep' && !isStopped && !isCompleted) {
                container.innerHTML += `<div class="pt-6 mt-4 border-t border-slate-200"><button data-order-id="${orderId}" class="stop-order-btn btn-danger w-full"><i data-feather="pause-circle" class="w-6 h-6"></i><span>إيقاف الطلب</span></button></div>`;
            }
            feather.replace();
        }

        // --- EVENT HANDLERS & LOGIC ---
        logoutBtn.addEventListener('click', handleLogout);
        addOrderBtn.addEventListener('click', () => openModal(orderModal, modalContent));
        cancelBtn.addEventListener('click', () => closeModal(orderModal, modalContent));
        orderForm.addEventListener('submit', handleFormSubmit);
        cancelNotesBtn.addEventListener('click', () => closeModal(notesModal, notesModalContent));
        notesForm.addEventListener('submit', handleNotesFormSubmit);
        cancelStopBtn.addEventListener('click', () => closeModal(stopOrderModal, stopOrderModalContent));
        stopOrderForm.addEventListener('submit', handleStopOrderSubmit);
        closeArchiveModalBtn.addEventListener('click', () => closeModal(archiveDetailModal, archiveDetailModalContent));
        
        activeTab.addEventListener('click', () => {
            activeTab.classList.replace('tab-inactive', 'tab-active');
            archiveTab.classList.replace('tab-active', 'tab-inactive');
            activeContent.classList.remove('hidden');
            archivedContent.classList.add('hidden');
        });

        archiveTab.addEventListener('click', () => {
            archiveTab.classList.replace('tab-inactive', 'tab-active');
            activeTab.classList.replace('tab-active', 'tab-inactive');
            archivedContent.classList.remove('hidden');
            activeContent.classList.add('hidden');
        });

        const filterOrders = (term, orders) => orders.filter(order => 
            (order.orderCode?.toString().toLowerCase().includes(term)) ||
            (order.customerName?.toLowerCase().includes(term)) ||
            (order.productName?.toLowerCase().includes(term))
        );

        searchActiveInput.addEventListener('input', (e) => {
            renderActiveOrders(filterOrders(e.target.value.toLowerCase(), allActiveOrders));
        });

        searchArchiveInput.addEventListener('input', (e) => {
            renderArchivedOrders(filterOrders(e.target.value.toLowerCase(), allArchivedOrders));
        });

        mainContainer.addEventListener('click', async (e) => {
            // Active Order Expand/Collapse
            const expandBtn = e.target.closest('.expand-details-btn');
            if (expandBtn) {
                const orderId = expandBtn.dataset.orderId;
                const timelineContainer = document.getElementById(`timeline-${orderId}`);
                const icon = expandBtn.querySelector('i');

                if (timelineContainer.style.maxHeight && timelineContainer.style.maxHeight !== '0px') {
                    timelineContainer.style.maxHeight = '0px';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    const orderDocRef = doc(db, "orders", orderId);
                    const docSnap = await getDoc(orderDocRef);
                    if (docSnap.exists()) {
                        renderTimeline(timelineContainer, docSnap.data(), orderId);
                        timelineContainer.style.maxHeight = timelineContainer.scrollHeight + "px";
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }

            // Archive Order View Modal
            const viewArchiveBtn = e.target.closest('.view-archive-btn');
            if(viewArchiveBtn) {
                const orderId = viewArchiveBtn.dataset.orderId;
                const orderDocRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(orderDocRef);
                if (docSnap.exists()) {
                    const order = docSnap.data();
                    archiveModalTitle.textContent = `تفاصيل الطلب #${order.orderCode || 'N/A'}`;
                    renderTimeline(archiveModalBody, order, orderId);
                    openModal(archiveDetailModal, archiveDetailModalContent);
                }
            }
            
            // Timeline Buttons
            if (e.target.closest('.complete-stage-btn')) {
                const btn = e.target.closest('.complete-stage-btn');
                completeStage(btn.dataset.orderId, btn.dataset.stageId);
            }
            if (e.target.closest('.add-notes-btn')) {
                const btn = e.target.closest('.add-notes-btn');
                openNotesModal(btn.dataset.orderId, btn.dataset.stageId, btn.dataset.stageName, btn.dataset.currentNotes);
            }
            if (e.target.closest('.stop-order-btn')) {
                const btn = e.target.closest('.stop-order-btn');
                openStopOrderModal(btn.dataset.orderId);
            }
        });

        async function handleFormSubmit(e) {
            e.preventDefault();
            const counterRef = doc(db, "counters", "ordersCounter");
            let newOrderCode;
            try {
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    if (!counterDoc.exists()) {
                        newOrderCode = 1;
                        transaction.set(counterRef, { currentNumber: newOrderCode });
                    } else {
                        newOrderCode = counterDoc.data().currentNumber + 1;
                        transaction.update(counterRef, { currentNumber: newOrderCode });
                    }
                });
            } catch (error) {
                console.error("Transaction failed: ", error);
                alert("فشل إنشاء كود الطلب، يرجى المحاولة مرة أخرى.");
                return;
            }

            const orderType = orderTypeSelect.value;
            const requiresForm = document.getElementById('requires-form').checked;
            let stagesTemplate = JSON.parse(JSON.stringify(STAGES[orderType]));
            if (orderType === 'flexo') {
                if (!requiresForm) {
                    stagesTemplate = stagesTemplate.filter(s => s.id !== 'form');
                } else {
                    const designStage = stagesTemplate.find(s => s.id === 'design');
                    if (designStage) designStage.dependencies.push('form');
                }
            }
            const initialStages = stagesTemplate.map(stage => ({ id: stage.id, name: stage.name, dependencies: stage.dependencies, status: 'pending', startDate: null, endDate: null, notes: '' }));
            const firstStage = initialStages.find(s => s.dependencies.length === 0);
            if (firstStage) {
                firstStage.status = 'completed';
                firstStage.startDate = new Date();
                firstStage.endDate = new Date();
            }
            const newOrder = { orderCode: newOrderCode, customerName: document.getElementById('customer-name').value, productName: document.getElementById('product-name').value, quantity: parseInt(document.getElementById('quantity').value), orderType: orderType, status: 'active', createdAt: serverTimestamp(), createdBy: currentUser.uid, creatorEmail: currentUser.email, stages: initialStages };
            try { await addDoc(collection(db, "orders"), newOrder); closeModal(orderModal, modalContent); } catch (error) { console.error("Error adding order: ", error); alert("حدث خطأ أثناء إضافة الطلب."); }
        }

        async function handleNotesFormSubmit(e) { e.preventDefault(); const orderId = document.getElementById('notes-order-id').value; const stageId = document.getElementById('notes-stage-id').value; const notes = document.getElementById('stage-notes').value; const orderRef = doc(db, "orders", orderId); try { const orderSnap = await getDoc(orderRef); if (orderSnap.exists()) { const stages = [...orderSnap.data().stages]; const stageIndex = stages.findIndex(s => s.id === stageId); if (stageIndex !== -1) { stages[stageIndex].notes = notes; await updateDoc(orderRef, { stages: stages }); closeModal(notesModal, notesModalContent); } } } catch (error) { console.error("Error updating notes: ", error); alert("حدث خطأ أثناء تحديث الملاحظات."); } }
        async function handleStopOrderSubmit(e) { e.preventDefault(); const orderId = document.getElementById('stop-order-id').value; const reason = document.getElementById('stop-reason').value; const orderRef = doc(db, "orders", orderId); try { await updateDoc(orderRef, { status: 'stopped', stopReason: reason, stoppedAt: serverTimestamp() }); closeModal(stopOrderModal, stopOrderModalContent); } catch (error) { console.error("Error stopping order: ", error); alert("حدث خطأ أثناء إيقاف الطلب."); } }
        async function completeStage(orderId, stageIdToComplete) { if (userRole !== 'rep') return; const orderRef = doc(db, "orders", orderId); try { const orderSnap = await getDoc(orderRef); if (orderSnap.exists()) { const orderData = orderSnap.data(); const stages = [...orderData.stages]; const stageIndex = stages.findIndex(s => s.id === stageIdToComplete); if (stageIndex !== -1) { stages[stageIndex].status = 'completed'; stages[stageIndex].endDate = new Date(); if (!stages[stageIndex].startDate) stages[stageIndex].startDate = new Date(); } const allComplete = stages.every(s => s.status === 'completed'); const updates = { stages: stages }; if (allComplete) { updates.status = 'completed'; updates.completedAt = serverTimestamp(); } await updateDoc(orderRef, updates); } } catch (error) { console.error("Error updating stage: ", error); alert("حدث خطأ أثناء تحديث المرحلة."); } }
        function handleLogout() { if (unsubscribeActive) unsubscribeActive(); if (unsubscribeArchived) unsubscribeArchived(); signOut(auth).then(() => { window.location.href = 'login.html'; }).catch((error) => console.error('Logout Error:', error)); }

        // --- MODAL UTILITY FUNCTIONS ---
        function openModal(modal, content) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal(modal, content) {
            content.classList.add('scale-95', 'opacity-0');
            content.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function openNotesModal(orderId, stageId, stageName, currentNotes) {
            document.getElementById('notes-order-id').value = orderId;
            document.getElementById('notes-stage-id').value = stageId;
            document.getElementById('notes-modal-title').textContent = `ملاحظات على: ${stageName}`;
            document.getElementById('stage-notes').value = currentNotes;
            openModal(notesModal, notesModalContent);
        }
        
        function openStopOrderModal(orderId) {
            document.getElementById('stop-order-id').value = orderId;
            stopOrderForm.reset();
            openModal(stopOrderModal, stopOrderModalContent);
        }

        orderTypeSelect.addEventListener('change', () => {
             flexoOptions.classList.toggle('hidden', orderTypeSelect.value !== 'flexo');
        });
    </script>
</body>
</html>